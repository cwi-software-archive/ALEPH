
          IDENT  RANDOM
          SST
          ENTRY  RANDOM,R.WORD
 RANDOM   JP     *+1S17      RANDOM + >P + >Q + R>
*
* THE RANDOM NUMBER IS SQUEEZED INTO RANGE [P : Q] BY FIRST REDUCING
* THE RANGE TO [0 : 2**N - 1] BY MASKING, AND THEN, IF THE RESULT IS
* NOT IN THE RANGE, JUST TRY AGAIN. THIS IS CHEAPER THAN A MULTIPLY-
* DIVIDE APPROACH, ESPECIALLY WHEN THE RANGE IS LARGER THAN 'MAX INT'.
* ON THE AVERAGE 4/3 ATTEMPTS ARE NEEDED.
* THE TECHNIQUE IS EXPLAINED BY:
*
* RANDOM + >P + >Q + R> - RANGE - SIZE:
* MINUS + Q + P + RANGE, FIRST TRUE + RANGE + SIZE,
*  (ATTEMPT - BTS:
*   GET RANDOM BITS + SIZE + BTS $ GETS 'SIZE' RANDOM BITS IN 'BTS' $
*    (LSEQ + BTS + RANGE, PLUS + BTS + P + R;
*     : ATTEMPT)
*  ).
*
* THE ACTUAL ALGORITHM IS MESSIER BECAUSE OF POSSIBILITY OF OVERFLOW.
* THE "SIZE" IS IMPLEMENTED BY A MASK.
*
* REGISTER ALLOCATION:  (THOSE MARKED R ARE USED BY THE BIT-SHUFFLER)
*     X1  P, R
*     X2  Q, RANGE
*  R  X3  BTS
*  R  X4  TEMP, COPY OF RWORD
*  R  X5  TEMP, MASK FOR BIT-SHUFFLER
*  R  X6  R.WORD
*     X7  SIZE MASK
*
          SA4    R.WORD      GET LATEST BIT-WORD
          IX2    X2-X1       MINUS+Q+P+RANGE, MAY YIELD 49-BIT RESULT
          NG     X2,ERR      (OR EVEN BE NEGATIVE)
          AX5    X2,B1       SO WE MAKE IT A 48-BIT RESULT, BUT LOSE THE
                             DIFFERENCE BETWEEN 0 AND 1. THE ALGORITHM
                             WILL WORK NEVERTHELESS, BUT A RANGE OF
                             LENGTH 0 WILL GET BAD SERVICE.
          NX5    B5          FIRST TRUE + RANGE + SIZE,
          MX7    11          AND CONSTRUCT
          AX7    B5          MASK FOR 'SIZE'.
          BX6    X4          R.WORD
 ATTEMPT  BSS    0           BIT-SHUFFLER.
*
* THIS ALGORITHM PRODUCES THE BITSTREAM DESCRIBED AND ANALYZED
* BY R.C.TAUSWORTHE, MATH. COMP. 19(1965),201-209.
* THE BITSTREAM IS GENERATED IN BACKWARD ORDER, AND IS BASED ON THE
* PRIMITIVE TRINOMIAL  X ** 60 + X ** M + 1, WITH  0 < M < 13.
* THE PRESENT VALUE OF  M  IS:
 M        EQU    1
* BUT A BETTER VALUE MAY BE FOUND.
* THE BITSTREAM IS PRODUCED IN GROUPS OF 59 BITS.
*
          MX5    M           MASK FOR FIRST M BITS
          BX4    X6          COPY R.WORD
          LX6    60-M        SHIFT R.WORD RIGHT OVER M BITS
          BX4    -X5*X4      REMOVE FIRST M BITS FROM COPY
          BX6    X6-X4
* END OF BIT-SHUFFLER, X6 NOW CONTAINS 59 NEW BITS
          BX3    -X7*X6      REDUCE RANGE TO 'SIZE'
          IX5    X2-X3       LSEQ + BTS
          NG     X5,ATTEMPT             + RANGE,
          IX1    X3+X1       PLUS + BTS + P + R
          SA6    R.WORD      STORE NEW BITS
          EQ     RANDOM

 R.WORD   DATA   B12345670555507654321

 ERR      ERREXT (RANDOM, BAD RANGE),(D1,D2)
          END
