grep @ $1 >/tmp/$$.1
(
cat <<\!
1,$s/@//g
!
ed - /tmp/$$.1 <<\!
1,$s/^[^@]*@//
1,$s/[^a-z0-9_].*//
1,$s:.*:g/[^a-z0-9_]&[^a-z0-9_]/?`?+1s/^ */\&@/:
1,$p
q
!
cat <<\!
g/@@/s/@@*/@/g
1,$p
q!
!
) >/tmp/$$.2
</tmp/$$.2 ex - $1 | tr -d '\015'

rm /tmp/$$.[12]
